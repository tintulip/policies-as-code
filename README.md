# policies-as-code

## What is policies-as-code?

Policies-as-code are rules to be applied in the trusted pipeline to detect misconfigurations within Terraform files. These set of rules govern the behaviour of a software service and allows decoupling between the policies and the software service which allows the policy to be updated independently from the software and build them at scale. The rules are written in [rego](https://www.openpolicyagent.org/docs/latest/policy-language/) and use OPA (open policy agent) for the policy engine. [conftest](https://www.conftest.dev/) is a utility that helps in writing tests against structured configuration data and relies upon the Rego language from OPA for policies.

## Getting Started

To run the tests, conftest must be installed. Instructions to do so are found [here](https://www.conftest.dev/install/)

The policies can be executed against a JSON terraform plan. The plan can be generated by the following commands:

```bash
(from the terraform dir)
terraform -chdir=./path/to/src plan -no-color -out=preproduction.tfplan
terraform -chdir=./path/to/src show -json -no-color preproduction.tfplan > preproduction.json
```

Then conftest can be ran against the plan using the conftest binary:

```bash
conftest test -p policies -p exceptions preproduction.json
```

### Confectionery

The policies are supported by using a library called [Confectioney](https://github.com/Cigna/confectionery/blob/main/README.md). These contain a collection of standardized [rules](https://github.com/Cigna/confectionery/tree/main/rules) used to manage and govern Terraform resources.

To leverage the library, the command used to run conftest slightly changes:


```bash
conftest test -p policy -p policies -p exceptions --update "git::https://github.com/cigna/confectionery.git//rules/terraform?ref=v1.0.0" preproduction.json
```

### Creating Rules

Rules are created in the [policies](./policies) directory. Rules must be packaged as `rules.<rule_name>`. More information about creating rules can be found [here](https://github.com/Cigna/confectionery/blob/main/rules/README.md#creating-or-modifying-rulespolicies)

The input that rules receive is in two parts: `_plan` and `resources`. The plan contains all of the different configuration and keeps track of which module calls to make as well as any variables. The resources section keeps track of each individual resource, including the provider and type as well as its address.

```example_input.json
{
  "_plan": {
    "configuration": {
      "root_module": {
        "resources": [
          {
            "address": "null_resource.example",
            "mode": "managed",
            "name": "example",
            "provider_config_key": "null",
            "provisioners": [
              {
                "expressions": {
                  "command": {
                    "constant_value": "echo Hello World"
                  }
                },
                "type": "local-exec"
              }
            ],
            "schema_version": 0,
            "type": "null_resource"
          }
        ]
      }
    }
  },
  "resources": {
    "null_resource.example": {
      "_id": "",
      "_mode": "managed",
      "_provider": "null",
      "_type": "null_resource",
      "id": "null_resource.example",
      "triggers": null
    }
  }
}
```

### Waivers/Exceptions

Sometimes it may be necessary to temporarily suppress a rule. For this, the [config.rego](./exceptions/config.rego) contains a list of rules that are currently being ignored. More information on how to use exceptions can be found [here](https://github.com/Cigna/confectionery#how-to-use-exceptions)

## Running in the pipeline

This repository runs as a secondary source within AWS CodeBuild. Once a plan has been generated in JSON, then conftest can be executed. An example below shows how the name of the `input_artifact` (policies) can be used with the `$CODEBUILD_SRC_DIR` environment variable to execute the right policies.

```bash
- ./conftest test -p policy -p $CODEBUILD_SRC_DIR_policies/policies -p $CODEBUILD_SRC_DIR_policies/exceptions --update "git::https://github.com/cigna/confectionery.git//rules/terraform?ref=v1.0.0" preproduction.json
```